<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitações - Painel Alcides Maya</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- CSS da Escola (Separado) -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-light">

    <script>
        const API_URL = 'http://localhost:8080/api-escola/api.php';
        
        // Simulação de verificação de autenticação
        const savedAuth = localStorage.getItem('admin_auth');
        if (!savedAuth) {
            window.location.href = 'index.html'; // Redireciona para o login se não estiver logado
        }
        const APP_STATE = { userName: savedAuth ? JSON.parse(savedAuth).name : 'Admin' };
        
        function handleLogout() {
            localStorage.removeItem('admin_auth');
            window.location.href = 'index.html';
        }

        async function fetchData(acao, id = null) {
            let url = `${API_URL}?acao=${acao}`;
            if (id) {
                url += `&id=${id}`;
            }
            try {
                const response = await fetch(url);
                return await response.json();
            } catch (error) {
                console.error("API GET Error:", error);
                return { sucesso: false, dados: [] };
            }
        }

        function renderSolicitacoes() {
            const tableEl = document.getElementById('solicitacoes-table');
            const bodyEl = document.getElementById('solicitacoes-body');
            const loadingEl = document.getElementById('solicitacoes-loading');

            loadingEl.classList.remove('d-none');
            tableEl.classList.add('d-none');
            bodyEl.innerHTML = '';

            fetchData('solicitacoes', 1) // Busca dados do aluno ID 1 (simulação)
                .then(data => {
                    loadingEl.classList.add('d-none');
                    if (data.sucesso && data.dados.length > 0) {
                        data.dados.forEach(sol => {
                            const statusMap = {
                                'PENDENTE': { text: 'Pendente', class: 'bg-warning text-dark' },
                                'EM_ANALISE': { text: 'Em Análise', class: 'bg-info text-white' },
                                'RESOLVIDO': { text: 'Resolvido', class: 'bg-success text-white' }
                            };
                            const statusInfo = statusMap[sol.status] || { text: 'Desconhecido', class: 'bg-secondary text-white' };

                            const row = `
                                <tr>
                                    <td>#${sol.id}</td>
                                    <td>${sol.id_aluno}</td>
                                    <td><span class="badge bg-secondary">${sol.setor}</span></td>
                                    <td>${sol.assunto}</td>
                                    <td>${new Date(sol.data_criacao).toLocaleDateString('pt-BR')}</td>
                                    <td>
                                        <span class="badge ${statusInfo.class} fw-bold">
                                            ${statusInfo.text}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-info text-white me-2">Responder</button>
                                    </td>
                                </tr>
                            `;
                            bodyEl.innerHTML += row;
                        });
                        tableEl.classList.remove('d-none');
                    } else {
                        document.getElementById('solicitacoes-container').innerHTML = `<div class="alert alert-info text-center mt-4">Nenhum ticket aberto encontrado.</div>`;
                    }
                })
                .catch(() => {
                    loadingEl.classList.add('d-none');
                    document.getElementById('solicitacoes-container').innerHTML = `<div class="alert alert-danger text-center mt-4">Erro ao carregar dados da API. Verifique o XAMPP.</div>`;
                });
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('admin-name').textContent = APP_STATE.userName;
            lucide.createIcons();
            renderSolicitacoes(); // Chama a função para carregar os dados ao iniciar
        });
    </script>


    <div class="d-flex flex-row" style="height: 100vh;">
        <!-- SIDEBAR -->
        <aside class="sidebar d-flex flex-column" style="width: 250px;">
            <div class="sidebar-header d-flex flex-column align-items-center justify-content-center p-3" style="height: 80px;">
                <span class="font-weight-bolder fs-4">Alcides Maya</span>
                <span class="fs-6">Painel Administrativo</span>
            </div>

            <nav class="flex-grow-1 py-4 px-3">
                <div class="list-group list-group-flush">
                    <a href="avisos.html" class="sidebar-item list-group-item list-group-item-action p-3 mb-1">
                        <i data-lucide="bell" class="w-5 h-5 me-2"></i>
                        <span>Disparar Avisos</span>
                    </a>
                    <a href="chat.html" class="sidebar-item list-group-item list-group-item-action p-3 mb-1">
                        <i data-lucide="message-square" class="w-5 h-5 me-2"></i>
                        <span>Chat NADD</span>
                    </a>
                    <a href="solicitacoes.html" class="sidebar-item list-group-item list-group-item-action p-3 mb-1 active">
                        <i data-lucide="file-text" class="w-5 h-5 me-2"></i>
                        <span>Solicitações</span>
                    </a>
                </div>
            </nav>

            <div class="p-3 border-top">
                <p class="text-sm text-muted mb-2">Logado como: <span id="admin-name"></span></p>
                <button onclick="handleLogout()" class="btn btn-outline-danger w-100 d-flex align-items-center justify-content-center gap-2">
                    <i data-lucide="log-out" class="w-5 h-5 me-2"></i>
                    <span>Sair</span>
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-grow-1 d-flex flex-column overflow-hidden">
            <header class="bg-white shadow-sm d-flex align-items-center justify-content-between px-4 border-bottom" style="height: 60px;">
                <h1 class="fs-5 fw-semibold text-dark">Gestão de Solicitações</h1>
                <div class="d-flex align-items-center">
                    <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center text-dark" style="width: 40px; height: 40px; font-weight: bold;">
                        <i data-lucide="user" class="w-5 h-5"></i>
                    </div>
                </div>
            </header>

            <div class="flex-grow-1 overflow-auto p-4">
                <div id="solicitacoes-container" class="card shadow-lg overflow-hidden" style="border: none;">
                    <h2 class="fs-4 fw-bold p-4 border-bottom">Tickets em Aberto/Resumo</h2>
                    
                    <div class="p-4 text-center text-muted" id="solicitacoes-loading">Carregando dados da API...</div>
                    
                    <div class="table-responsive">
                        <table id="solicitacoes-table" class="table table-striped table-hover mb-0 d-none">
                            <thead class="bg-light">
                                <tr>
                                    <th class="p-3">ID</th>
                                    <th class="p-3">Aluno ID</th>
                                    <th class="p-3">Setor</th>
                                    <th class="p-3">Assunto</th>
                                    <th class="p-3">Data</th>
                                    <th class="p-3">Status</th>
                                    <th class="p-3">Ação</th>
                                </tr>
                            </thead>
                            <tbody id="solicitacoes-body">
                                <!-- Dados serão injetados aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>