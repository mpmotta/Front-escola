<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avisos - Painel Alcides Maya</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- CSS da Escola (Separado) -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-light">

    <!-- Variáveis Globais (Definidas aqui, ou lidas do localStorage) -->
    <script>
        const API_URL = 'http://localhost/api-escola/api.php';
        let APP_STATE = {
            isLoggedIn: true,
            userName: 'Coordenação',
        };
        
        // Simulação de verificação de autenticação
        const savedAuth = localStorage.getItem('admin_auth');
        if (!savedAuth) {
            window.location.href = 'index.html'; // Redireciona para o login se não estiver logado
        } else {
            APP_STATE.userName = JSON.parse(savedAuth).name;
        }

        function handleLogout() {
            localStorage.removeItem('admin_auth');
            window.location.href = 'index.html';
        }
        
        function showMessage(type, text, targetId) {
            const el = document.getElementById(targetId);
            el.className = `alert alert-${type === 'success' ? 'success' : 'danger'} d-block`;
            el.textContent = text;
            el.classList.remove('d-none');
            setTimeout(() => { el.classList.add('d-none'); }, 5000);
        }
        
        async function postData(acao, body) {
            try {
                const response = await fetch(`${API_URL}?acao=${acao}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                return await response.json();
            } catch (error) {
                return { sucesso: false, mensagem: "Erro de conexão com o servidor." };
            }
        }

        async function handleAvisoSubmit(button) {
            const titulo = document.getElementById('aviso-titulo').value;
            const corpo = document.getElementById('aviso-corpo').value;
            // Prioridade SEMPRE ALTA, conforme o requisito
            const prioridade = 'alta'; 
            const target = document.getElementById('aviso-target').value;
            
            if (!titulo || !corpo) {
                showMessage('danger', 'Preencha o título e a mensagem.', 'aviso-message');
                return;
            }
            
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Enviando...';

            const response = await postData('disparar_aviso', {
                titulo: titulo,
                corpo: corpo,
                prioridade: prioridade,
                id_turma_alvo: target === 'null' ? null : parseInt(target)
            });

            if (response.sucesso) {
                showMessage('success', response.mensagem + ' (Verifique o log de push no console).', 'aviso-message');
                document.getElementById('aviso-titulo').value = '';
                document.getElementById('aviso-corpo').value = '';
            } else {
                showMessage('danger', response.mensagem || 'Falha ao salvar. Verifique o console.', 'aviso-message');
            }

            button.disabled = false;
            button.innerHTML = 'ENVIAR E SALVAR AVISO';
        }

        // Função que renderiza o nome do admin ao carregar
        document.addEventListener('DOMContentLoaded', () => {
             document.getElementById('admin-name').textContent = APP_STATE.userName;
             lucide.createIcons(); // Ativa os ícones visuais
        });

    </script>


    <div class="d-flex flex-row" style="height: 100vh;">
        <!-- SIDEBAR -->
        <aside class="sidebar d-flex flex-column" style="width: 250px;">
            <div class="sidebar-header d-flex flex-column align-items-center justify-content-center p-3" style="height: 80px;">
                <span class="font-weight-bolder fs-4">Alcides Maya</span>
                <span class="fs-6">Painel Administrativo</span>
            </div>

            <nav class="flex-grow-1 py-4 px-3">
                <div class="list-group list-group-flush">
                    <!-- Link Ativo -->
                    <a href="avisos.html" class="sidebar-item list-group-item list-group-item-action p-3 mb-1 active">
                        <i data-lucide="bell" class="w-5 h-5 me-2"></i>
                        <span>Disparar Avisos</span>
                    </a>
                    <!-- Links Inativos -->
                    <a href="chat.html" class="sidebar-item list-group-item list-group-item-action p-3 mb-1">
                        <i data-lucide="message-square" class="w-5 h-5 me-2"></i>
                        <span>Chat NADD</span>
                        <span class="badge bg-danger rounded-pill float-end">2</span>
                    </a>
                    <a href="solicitacoes.html" class="sidebar-item list-group-item list-group-item-action p-3 mb-1">
                        <i data-lucide="file-text" class="w-5 h-5 me-2"></i>
                        <span>Solicitações</span>
                        <span class="badge bg-danger rounded-pill float-end">5</span>
                    </a>
                </div>
            </nav>

            <div class="p-3 border-top">
                <p class="text-sm text-muted mb-2">Logado como: <span id="admin-name"></span></p>
                <button onclick="handleLogout()" class="btn btn-outline-danger w-100 d-flex align-items-center justify-content-center gap-2">
                    <i data-lucide="log-out" class="w-5 h-5 me-2"></i>
                    <span>Sair</span>
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-grow-1 d-flex flex-column overflow-hidden">
            <header class="bg-white shadow-sm d-flex align-items-center justify-content-between px-4 border-bottom" style="height: 60px;">
                <h1 class="fs-5 fw-semibold text-dark">Disparar Avisos</h1>
                <div class="d-flex align-items-center">
                    <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center text-dark" style="width: 40px; height: 40px; font-weight: bold;">
                        <i data-lucide="user" class="w-5 h-5"></i>
                    </div>
                </div>
            </header>

            <div class="flex-grow-1 overflow-auto p-4">
                <div class="d-flex justify-content-center">
                    <div class="card shadow-lg p-4 mt-3" style="max-width: 900px; width: 100%;">
                        <h2 class="fs-4 fw-bold text-dark mb-4 d-flex align-items-center">
                            <i data-lucide="bell" class="text-primary me-2 w-6 h-6"></i> Criar Novo Aviso e Disparar Push
                        </h2>
                        
                        <div id="aviso-message" class="alert d-none" role="alert"></div>

                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label font-weight-bold">Título do Aviso</label>
                                <input type="text" id="aviso-titulo" class="form-control focus-alcides" placeholder="Ex: Provas Finais">
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label font-weight-bold">Mensagem (Corpo)</label>
                                <textarea rows="4" id="aviso-corpo" class="form-control focus-alcides" placeholder="Digite o conteúdo da notificação..."></textarea>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label font-weight-bold">Público Alvo</label>
                                <select id="aviso-target" class="form-select focus-alcides">
                                  <option value="null">Todos os Alunos</option>
                                  <option value="1">Téc. Informática</option>
                                  <option value="2">Enfermagem</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label font-weight-bold">Prioridade da Notificação</label>
                                <input type="text" class="form-control" value="ALTA (Sirene Vital)" disabled>
                                <input type="hidden" id="aviso-prioridade" value="alta"> <!-- Campo oculto -->
                            </div>

                            <div class="col-12">
                                <button id="aviso-btn" onclick="handleAvisoSubmit(this)" class="btn btn-alcides w-100">
                                    ENVIAR E SALVAR AVISO
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>